---
title: 球谐函数及其在 3D Gaussian Splatting 中的应用
date: 2025-10-15
mathjax: true
---

最近课题涉及 3D Gaussian Splatting，需要记录学习下一些很久没碰过的概念，~~基本等于重学，因为个人原因也很久没用 LaTeX 了打错就打错了也懒得改了~~。

## 球谐函数（Spherical Harmonics, SH）

### 直观理解

可以把球谐函数理解为：**球面上的“傅里叶基”函数。**

在一维情况下：

-   任意周期函数可以展开成**傅里叶级数**（由 $sin$ 和 $cos$ 组成）。
    
在三维球坐标下（$r$, $\theta$, $\phi$）：

-   我们常常只关心角度部分（$\theta$ 为极角，$\phi$ 为方位角）。
    
-   球谐函数就是在球面上起到类似作用的一组**完备正交基**。

**换句话说：**
任何定义在球面上的函数 $f(\theta, \phi)$ 都可以被分解为球谐函数的加权和：

$$
f(\theta, \phi) = \sum_{l=0}^{\infty}\sum_{m=-l}^{l} c_{lm} Y_l^m(\theta, \phi)
$$

### 数学定义（抄的[Wikipedia](https://en.wikipedia.org/wiki/Spherical_harmonics#Laplace's_spherical_harmonics)）

球谐函数 $Y_l^m(\theta, \phi)$ 通常定义为：

$$
Y_l^m(\theta, \phi) = N_l^m P_l^{|m|}(\cos\theta) e^{i m \phi}
$$

其中：

-   $l$ = 阶数（degree），非负整数 $l = 0, 1, 2, ...$
    
-   $m$ = 次序（order），整数，取值范围 $-l \le m \le l$
    
-   $P_l^{|m|}$ = 关联勒让德多项式 (associated Legendre polynomial)
    
-   $N_l^m$ = 归一化常数（保证正交性）
    

这就像二维傅里叶基里的 $e^{i m \phi}$ 一样，只不过现在角度更复杂（球面而不是圆）。

### 正交与完备性

球谐函数在球面上是**正交**的：

$$
\int_0^{2\pi}\int_0^{\pi} Y_l^m(\theta, \phi) \, Y_{l'}^{m'*}(\theta, \phi)\, \sin\theta\, d\theta\, d\phi = \delta_{ll'} \delta_{mm'}
$$

这意味着它们互相独立，可以组成任意球面函数的基。

### 可视化理解

每个 $Y_l^m$ 在球面上代表一个有特定“波纹”模式的函数：

-   $l$：控制波的“纬向”数量（越大 → 越细腻的角度细节）
    
-   $m$：控制波的“经向”变化（正负决定相位旋转方向）
    

| $l$ | $m$ | 外观（球面模式） | 含义 |
| :---: | :---: | :---: | :---: |
| $0$ | $0$ | 常数（光滑球面） | 全局平均 |
| $1$ | $-1,0,1$ | 三个方向的线性变化 | 类似 xyz 三个轴 |
| $2$ | $-2,-1,0,1,2$ | 二次变化 | 类似二阶高斯/光照方向模式 |

这就是为什么在 CG 中可以用**前几阶球谐函数**来逼近光照环境。在 **Gaussian Splatting** 用于表示方向相关的密度、颜色或光照场。

### 一个简单例子

当 $l=0,1,2$ 时的实球谐函数（取实部）大致如下：

| 符号 | 形式（简写） | 类似方向分布 |
| :---: | :---: | :---: |
| $Y_0^0$ | 常数 | 全局亮度 |
| $Y_1^{-1}, Y_1^0, Y_1^1$ | $x, y, z$ | 线性梯度（方向性） |
| $Y_2^m$ | $x^2, xy, yz$ 等 | 二阶方向分布（阴影、反射方向） |

所以在 CG 里，前三阶（$l \leq 2$）球谐函数就足够近似自然环境光。

## 3D Gaussian Splatting 中的应用

**为什么在 3D Gaussian Splatting 中，球谐函数（Spherical Harmonics, SH）能用于表示随视角变化的颜色或密度？**  

可从**直觉 → 数学 → 代码实现 → 实际意义** 四个层面理解这一部分。

### 直觉层面：为什么需要「方向相关」的表示？

在 **3D Gaussian Splatting (3DGS)** 里，每个点（Gaussian）代表场景中的一个小区域，它有：

-   一个位置 $x y z$
    
-   一个形状（协方差矩阵）
    
-   一个颜色（或者强度）
    
每个高斯点不只需要需要一个固定颜色，因为现实中：

> **物体的颜色往往会随观察方向而变化。**

例如：

-   车漆面反光：从不同角度看亮度不同；
    
-   玻璃、金属表面：反射强烈依赖视角；
    
-   柔性物体：光照变化导致颜色随方向微妙变化。
    

这些都属于 **view-dependent effects**。而一个固定 RGB（3 维）无法表达这种变化，这点和 NeRF 有类似之处。但话又说回来了，NeRF 是发射一道 Ray 算整个 Ray 上的积分，也不完全一样。

于是，我们希望每个高斯点的颜色不是常数，而是一个**函数**：

$$
c(\mathbf{d}) = f(\text{view direction } \mathbf{d})
$$

表示“从方向 $\mathbf{d}$”看过去时，这个点的颜色是多少。

### 问题本质：颜色是球面上的函数

观察方向（可以理解为相机坐标系原点到 Gaussian 球的向量）可以用球面坐标表示：

$$
\mathbf{d} = (\theta, \phi)
$$

（$\theta$ 是仰角，$\phi$ 是方位角）

于是，每个点的颜色实际上是**定义在单位球面上的函数**：

$$
c : S^2 \to \mathbb{R}^3
$$

这就成了典型的“球面函数表示问题”。就像时间信号可以用傅里叶级数分解一样，球面函数也可以用一组基函数（球谐函数）分解。

### 用球谐函数展开颜色函数

我们用球谐函数 $Y_l^m(\theta, \phi)$ 展开颜色函数：

$$
c(\theta, \phi) = \sum_{l=0}^{L} \sum_{m=-l}^{l} c_{lm} Y_l^m(\theta, \phi)
$$

**其中：**

-   $L$：展开的最高阶，控制表示能力；
    
-   $c_{lm}$：每个高斯点学得的系数（即“球谐系数”）；
    
-   $Y_l^m$：固定的球谐基函数。
    

这样一来，一个点的颜色随方向变化的模式，就由这些系数控制了。

**就像：**

-   $L=0$：常数项（各方向同色）
    
-   $L=1$：能表现“线性方向性”，比如亮面和阴面
    
-   $L=2$ 以上：能表现更复杂的反射和镜面变化

### 从直觉理解 SH 的方向性

下面是几阶球谐函数（实数形式）的大致“形状”：

| 阶数 $l$ | 模式示意 | 直觉意义 |
| :---: | :---: | :---: |
| 0 | 常数（全方向一样） | 漫反射 / 平均颜色 |
| 1 | 线性梯度（前亮后暗） | 方向光反射 |
| 2 | 二次变化（中心亮边暗） | 柔和高光 / 阴影边界 |
| 3+ | 细节更多 | 更复杂的反射和微结构光照 |

所以我们可以理解为：

> 球谐展开提供了一种“低频到高频”的方向函数逼近方式。

在神经渲染中，因为反射/光照场一般变化较平滑，通常只用前几阶（如 $L=3$，共 16 维）。

## 从原理看 Gaussian Splatting 如何使用 SH

在 3DGS 的实现中（例如 *Kerbl et al. 2023*），每个 Gaussian 球存储：

-   一个中心位置
    
-   一个协方差矩阵（形状）
    
-   **一组球谐系数** $c_{lm}$

渲染时的过程如下：

1.  **计算视线方向**  
    对于相机射向该高斯的方向，得到单位向量 $\mathbf{d}$。
    
2.  **计算球谐基值**  
    对该方向计算所有基函数 $Y_l^m(\mathbf{d})$。
    
3.  **加权求和颜色：**
    
    $$
    c(\mathbf{d}) = \sum_{l,m} c_{lm} Y_l^m(\mathbf{d})
    $$
    
    得到此视角下该高斯的颜色。
    
4.  **与其他高斯叠加渲染图像。**
    

### 代码/实现角度举例

在实际代码（如 `sh_utils.py`）中，通常会有这样的流程：

```python
def eval_sh(basis_dim, coeffs, view_dir):
    # view_dir: [N, 3] 视角方向
    # coeffs: [N, basis_dim, 3] 球谐系数（每个点 RGB 各有一组）
    # basis_dim: (L+1)^2

    sh_basis = compute_sh_basis(basis_dim, view_dir)  # [N, basis_dim]
    color = torch.sum(sh_basis[..., None] * coeffs, dim=-2)
    return color
```

`compute_sh_basis()` 根据 $(\theta, \phi)$ 计算一组基函数值。`coeffs` 是每个高斯存的学习参数。最后相乘相加得到该方向下的颜色。

在训练中，渲染误差会反向传播到 `coeffs`，于是每个点自然学会“哪个方向该亮、哪个方向该暗”。

### 3D Gaussian Splatting 官方实现

[链接](https://github.com/graphdeco-inria/gaussian-splatting/blob/main/gaussian_renderer/__init__.py#L70)

---

### 与其他表示方式的对比

| 表示方式 | 特点 | 适用场景 |
| --- | --- | --- |
| 固定 RGB | 简单、快 | 漫反射场景 |
| 球谐函数 (SH) | 表示平滑方向依赖，计算快（线性） | 中等复杂度的反射、柔光 |
| MLP (Neural View-dependence) | 高表达能力但慢 | 高频反射、镜面等 |
| Spherical Gaussian / Neural Radiance Field | 连续方向建模 | 精确视角反射 |

> 在 Gaussian Splatting 中，球谐函数用于在单位球面上对颜色或密度进行“角度展开”，  
> 使得每个高斯点能根据观察方向动态改变外观，  
> 既保留了高效线性结构，又能表达方向相关的光照效果。


3DGS 选择 **球谐函数** 是一个**效率与表现力平衡点**：

-   只需存少量系数；
-   渲染时只要线性组合；
-   训练稳定（但搁我这不稳定，我的N卡大概是假的）；
-   还能表达基本的方向光反射。
    